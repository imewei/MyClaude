workflow:
  name: "refactoring-workflow"
  description: "Safe refactoring workflow with backup, validation, and rollback"
  version: "1.0"
  author: "Claude Code Framework"
  tags: [refactoring, safety, testing]
  rollback_on_error: true

variables:
  target_path: "."
  language: "auto"
  backup_branch: "refactor-backup"

steps:
  - id: create_backup
    command: commit
    description: "Create backup commit before refactoring"
    flags:
      - --staged
      - --ai-message
    rollback_command: git
    rollback_flags: ["checkout", "-b", "${backup_branch}"]

  - id: run_tests_baseline
    command: run-all-tests
    description: "Run baseline tests before refactoring"
    flags:
      - --scope=all
      - --coverage
      - --report
    depends_on: [create_backup]

  - id: analyze_complexity
    command: check-code-quality
    description: "Analyze code complexity"
    flags:
      - --language=${language}
      - --analysis=thorough
      - --format=json
    input: ${target_path}
    depends_on: [run_tests_baseline]

  - id: apply_refactoring
    command: refactor-clean
    description: "Apply refactoring patterns"
    flags:
      - --language=${language}
      - --scope=project
      - --patterns=modern
      - --implement
      - --report=detailed
    input: ${target_path}
    depends_on: [analyze_complexity]
    on_error: rollback

  - id: clean_after_refactor
    command: clean-codebase
    description: "Clean up after refactoring"
    flags:
      - --imports
      - --dead-code
      - --duplicates
      - --ast-deep
    input: ${target_path}
    depends_on: [apply_refactoring]

  - id: run_tests_validation
    command: run-all-tests
    description: "Validate refactoring with tests"
    flags:
      - --scope=all
      - --coverage
      - --auto-fix
    depends_on: [clean_after_refactor]
    on_error: rollback

  - id: check_performance
    command: run-all-tests
    description: "Check for performance regression"
    flags:
      - --profile
      - --benchmark
    depends_on: [run_tests_validation]

  - id: verify_quality
    command: check-code-quality
    description: "Verify quality improvements"
    flags:
      - --language=${language}
      - --analysis=thorough
      - --report
    input: ${target_path}
    depends_on: [check_performance]

  - id: commit_refactoring
    command: commit
    description: "Commit refactoring changes"
    flags:
      - --all
      - --ai-message
      - --validate
    depends_on: [verify_quality]
    condition: "verify_quality.success"